{% extends "base.html" %}
{% block content %}

<div id="top-dashboard">
    <h2>Live AQI Dashboard</h2>

    <input type="text" id="city" placeholder="Enter City">
    <button onclick="getAQI()">Search</button>

    <h3 id="aqi-category"></h3>
</div>
<!-- Radar Chart -->
<div style="width: 95%; max-width: 700px; height: 450px; margin: 40px auto;">
    <canvas id="radarChart"></canvas>
</div>

<!-- History Chart -->
<div style="width: 95%; max-width: 1100px; height: 500px; margin: 40px auto;">
    <canvas id="trendChart"></canvas>
</div>

<!-- Heatmap -->
<div style="width: 95%; max-width: 1100px; height: 550px; margin: 40px auto;">
    <div id="map" style="height:100%; width:100%;"></div>
</div>

<script>

let radarChart = null;
let trendChart = null;
let heatLayer = null;

/* ---------------- MAP INITIALIZATION ---------------- */
let map = L.map('map').setView([20.5937, 78.9629], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);


/* ---------------- MAIN SEARCH FUNCTION ---------------- */
function getAQI(){

    let city = document.getElementById("city").value;

    if(!city){
        alert("Please enter a city");
        return;
    }

    fetch(`/api/aqi/?city=${city}`)
    .then(r => r.json())
    .then(data => {

        if(data.error){
            alert(data.error);
            return;
        }

        // Update AQI text
        document.getElementById("aqi-category").innerText =
            `AQI: ${data.aqi} (${data.category})`;

        // Radar Chart
        if (radarChart !== null) {
            radarChart.destroy();
        }

        radarChart = new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
        labels: ["PM2.5","PM10","CO","NO2","O3"],
        datasets: [{
            label: "Pollutants",
            data: [
                data.pm25,
                data.pm10,
                data.co,
                data.no2,
                data.o3
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

        // Load History
        loadHistory(city);

        // ðŸ”¥ Load Heatmap (ONLY HERE)
        loadHeatmap(city);

    });
}


/* ---------------- LOAD HISTORY ---------------- */
function loadHistory(city){

    fetch(`/api/history/?city=${city}`)
    .then(r => r.json())
    .then(historyData => {

        if (trendChart !== null) {
            trendChart.destroy();
        }

        const history = historyData.history;
        const forecast = historyData.forecast;

        trendChart = new Chart(document.getElementById("trendChart"), {
            type: "line",
            data: {
                labels: [
                    ...history.map((_, i) => "Day " + (i + 1)),
                    "Next Day"
                ],
                datasets: [
                    {
                        label: "Historical AQI",
                        data: history,
                        borderColor: "blue",
                        backgroundColor: "blue",
                        fill: false,
                        tension: 0.3
                    },
                {
    label: "Predicted AQI",
    data: [
        ...history,
        forecast
    ],
    borderColor: "red",
    borderDash: [6,6],
    fill: false,
    tension: 0.3
}


                ]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    legend:{
                        display:true
                    }
                },
                scales:{
                    y:{
                        beginAtZero:true
                    }
                }
            }
        });

    });
}


/* ---------------- LOAD HEATMAP ---------------- */
function loadHeatmap(city){

    fetch(`/api/heatmap/?city=${city}`)
    .then(r => r.json())
    .then(data => {

        map.setView([data.center_lat, data.center_lon], 12);

        let heatPoints = data.zones.map(zone => [
        zone.lat,
        zone.lon,
        Math.min(zone.aqi / 300, 1)  // realistic AQI max
    ]);


        if (heatLayer !== null) {
            map.removeLayer(heatLayer);
        }

        heatLayer = L.heatLayer(heatPoints, {
            radius: 45,          // Smaller radius = realistic density
            blur: 35,            // More blur = smooth blending
            maxZoom: 18,
            minOpacity: 0.4,
            max: 300,            // Max AQI scale
            gradient: {
                0.0: '#2dc937',   // green
                0.25: '#99c140',  // light green
                0.4: '#e7b416',   // yellow
                0.6: '#db7b2b',   // orange
                0.8: '#cc3232',   // red
                1.0: '#660000'    // deep maroon
            }
        }).addTo(map);

    });

}

</script>

{% endblock %}
